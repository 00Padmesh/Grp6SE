{% extends "base.html" %}
{% block content %}

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<div style="margin-bottom: 30px;">
    <h2>üëã Welcome back, {{ current_user.name }}!</h2>
    <div style="display: flex; gap: 20px;">
        <div class="card" style="flex: 1; padding: 15px; background: #e0f2fe; margin-bottom: 0; text-align: center;">
            <h1 style="margin: 0; color: var(--primary);">{{ my_events_list|length }}</h1>
            <p style="margin: 0;">Events Registered</p>
        </div>
        <div class="card" style="flex: 1; padding: 15px; background: #dcfce7; margin-bottom: 0; text-align: center;">
            <h1 style="margin: 0; color: var(--success);">{{ events|length }}</h1>
            <p style="margin: 0;">Total Events Available</p>
        </div>
    </div>
</div>

<div style="display: flex; gap: 30px; flex-wrap: wrap;">
    
    <div style="flex: 2; min-width: 300px;">
        
        <div class="card">
            <h3>üìÖ Event Calendar</h3>
            <div id='calendar'></div>
        </div>

        <div class="card">
            <h3>‚úÖ My Registered Events</h3>
            {% if my_events_list %}
                <ul style="list-style: none; padding: 0;">
                    {% for event in my_events_list %}
                    <li style="border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{{ event.name }}</strong>
                            <br>
                            <small style="color: #666;">{{ event.start_date }} @ {{ event.start_time }}</small>
                        </div>
                        <a href="{{ url_for('unregister_event', event_id=event.id) }}" 
                           onclick="return confirm('Cancel registration?');">
                            <button style="background: var(--danger); padding: 5px 10px; font-size: 0.8rem; width: auto;">Cancel</button>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="color: #666; font-style: italic;">You haven't registered for any events yet.</p>
            {% endif %}
        </div>
    </div>

    <div style="flex: 3; min-width: 300px;">
        <h3>üéâ Browse All Events</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
            {% for event in events %}
            <div class="card" style="padding: 0; overflow: hidden; display: flex; flex-direction: column;">
                <img src="{{ url_for('static', filename='uploads/' + event.image_file) }}" style="width: 100%; height: 150px; object-fit: cover;">
                
                <div style="padding: 15px; flex-grow: 1;">
                    <h4 style="margin: 0 0 10px 0;">{{ event.name }}</h4>
                    <p style="color: #666; margin: 5px 0; font-size: 0.9rem;">üìÖ 
                        {% if event.start_date == event.end_date %}
                            {{ event.start_date }}
                        {% else %}
                            {{ event.start_date }} - {{ event.end_date }}
                        {% endif %}
                    </p>
                    <p style="color: #666; margin: 5px 0; font-size: 0.9rem;">‚è∞ {{ event.start_time }}</p>
                </div>

                <div style="padding: 15px; border-top: 1px solid #eee;">
                    {% if event.id in my_event_ids %}
                        <button style="background-color: var(--success); cursor: default; opacity: 0.8;">Registered</button>
                    {% else %}
                        <button 
                            class="view-btn"
                            data-name="{{ event.name }}"
                            data-date="{{ event.start_date }}"
                            data-start="{{ event.start_time }}"
                            data-end="{{ event.end_time }}"
                            data-desc="{{ event.description }}"
                            data-img="{{ url_for('static', filename='uploads/' + event.image_file) }}"
                            data-id="{{ event.id }}"
                            onclick="openModalFromData(this)">
                            View & Register
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="eventModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <img id="modalImg" src="" style="width:100%; height:250px; object-fit:cover; border-radius:8px;">
        <h2 id="modalTitle" style="margin-top: 15px;"></h2>
        <p><strong id="modalDate"></strong> | <span id="modalTime"></span></p>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 15px 0; max-height: 200px; overflow-y: auto;">
            <p id="modalDesc"></p>
        </div>
        <p style="color: var(--danger); font-size: 0.9rem;">‚ö†Ô∏è Confirm registration?</p>
        <a id="confirmBtn" href="#"><button>Confirm Registration</button></a>
    </div>
</div>

<script>
    // --- CALENDAR SETUP ---
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 400,
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            events: [
                // Loop through all events to show them on calendar
                // We highlight the ones the user is registered for in a different color
                {% for event in events %}
                {
                    title: '{{ event.name }}',
                    start: '{{ event.start_date }}',
                    end: '{{ event.end_date }}', // FullCalendar end is exclusive, but for visual this works
                    {% if event.id in my_event_ids %}
                        color: '#10b981', // Green for registered
                        title: '‚úÖ {{ event.name }}'
                    {% else %}
                        color: '#3b82f6', // Blue for available
                    {% endif %}
                },
                {% endfor %}
            ]
        });
        calendar.render();
    });

    // --- MODAL LOGIC (Same as before) ---
    function openModalFromData(btn) {
        // ... (Keep existing modal logic here) ...
        var name = btn.getAttribute('data-name');
        var date = btn.getAttribute('data-date');
        var start = btn.getAttribute('data-start');
        var end = btn.getAttribute('data-end');
        var desc = btn.getAttribute('data-desc');
        var imgUrl = btn.getAttribute('data-img');
        var eventId = btn.getAttribute('data-id');

        document.getElementById('modalTitle').innerText = name;
        document.getElementById('modalDate').innerText = "üìÖ " + date;
        document.getElementById('modalTime').innerText = "‚è∞ " + start + " - " + end;
        document.getElementById('modalDesc').innerText = desc;
        document.getElementById('modalImg').src = imgUrl;
        
        document.getElementById('confirmBtn').href = "/register/" + eventId;
        document.getElementById('eventModal').style.display = "block";
    }

    function closeModal() { document.getElementById('eventModal').style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById('eventModal')) closeModal(); }
</script>

{% endblock %}